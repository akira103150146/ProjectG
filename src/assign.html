<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>
  <link href='js/lib/full_calendar_lib/fullcalendar.css' rel='stylesheet' />
  <link href='js/lib/full_calendar_lib/fullcalendar.print.css' rel='stylesheet' media='print' />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <link href='css/assign.css' rel='stylesheet' />
  <script src='../../node_modules/moment/moment.js'></script>
  <script src='../../node_modules/jquery/dist/jquery.js'></script>
  <!-- Insert this line after script imports -->
  <script>if (window.module) module = window.module;</script>
  <script src='../../node_modules/components-jqueryui/jquery-ui.js'></script>
  <script src='js/lib/full_calendar_lib/fullcalendar.js'></script>
  <script src="js/app/sidebar.js"></script>
  <script src="js/app/assign.js"></script>
  <script>
    "use strict";
    var ipcrender = require('electron').ipcRenderer
    var sdlmanager = new SdlManager()
    var current_index = 0
    /////////////////////////////////伺服器回應/////////////////////////////////// 
    ipcrender.on('reply-Sdl',(event,info)=>{
      console.log(info)
      localStorage.setItem('Sdl-list',JSON.stringify(info))
      sdlmanager.ShowSdl()
    })
    ipcrender.on('reply-member', (event, info) => {
        console.log(info)
        localStorage.setItem('staff-assign',JSON.stringify(info))
        sdlmanager.AddStaff()
        //sdlmanager.ShowSdl(0, info)
    })
    ipcrender.on('reply-device', (event, info) => {
        localStorage.list_device = JSON.stringify(info)
        console.log(info)
        sdlmanager.ShowDevice()
      })  
    ipcrender.on('reply-form', function (event, info) {
        localStorage.list_form = JSON.stringify(info)//將傳入list存入local     
        console.log(info)
    })
    ipcrender.on('update-Sdl', (event, content, tag)=>{
       console.log('refresh')
       console.log(tag)
       console.log(content)
       sdlmanager.AssignSdl(tag, content.id)
      // ipcrender.send('ready-to-show', 'Sdl')
    })
    $(document).ready(function () {
    /////////////////////////////////顯示畫面/////////////////////////////////// 
      ipcrender.send('ready-to-show', 'member')
      ipcrender.send('ready-to-show', 'Sdl')
      ipcrender.send('ready-to-show', 'device')
      ipcrender.send('ready-to-show', 'form')
    /////////////////////////////////設定sidebar/////////////////////////////////// 
      sidebar_setup('bagi')
    /////////////////////////////////fullcalendar setup/////////////////////////////////// 
      $('#external-events .fc-event').each(function () {

        // store data so the calendar knows to render an event upon drop
        $(this).data('event', {
          title: $.trim($(this).text()), // use the element's text as the event title
          stick: true, // maintain when user navigates (see docs on the renderEvent method)
        });

        // make the event draggable using jQuery UI
        $(this).draggable({
          zIndex: 999,
          revert: true,      // will cause the event to go back to its
          revertDuration: 0  //  original position after the drag
        });

      });

      $('#calendar').fullCalendar({
        header: {
          left: 'prev,next today',
          center: 'title',
          right: 'month,agendaWeek,agendaDay'
        }, 
        editable: true,
        droppable: true, // this allows things to be dropped onto the calendar
        drop: function () {
          // is the "remove after drop" checkbox checked?
          if ($('#drop-remove').is(':checked')) {
            // if so, remove the element from the "Draggable Events" list
            $(this).remove();
          }
        },
        eventDragStop: function (event, jsEvent) {
          let x = jsEvent.pageX
          let y = jsEvent.pageY

          let cal   = $('#calendar')[0]
          let top   = cal.getBoundingClientRect().top + $(window)['scrollTop']()
          let right = cal.getBoundingClientRect().right + $(window)['scrollLeft']()
          let down  = cal.getBoundingClientRect().bottom + $(window)['scrollTop']()
          let left  = cal.getBoundingClientRect().left + $(window)['scrollLeft']()          
    
          if (!((x <= right ) && (x >= left) && (y >= top) && (y <= down))){ 
            if(Number.isInteger(event.id))
              sdlmanager.ThrowToBin(event.id)
            $('#calendar').fullCalendar('removeEvents', event.id)
            
          }
        }
      });

      $('#add-event-btn').on('click',()=>{
        $('#myModal')[0].style.display = "block"
        $('#calendar')[0].style.display = "none";
        $('#input-m_name')[0].value = ''
      })
       $('.close').on('click', ()=>{
          $('#myModal')[0].style.display = "none"
          $('#calendar')[0].style.display = "block";
       })
       $('#confirm').on('click',()=>{
          let dv = document.createElement('div')
         dv.contentEditable = true
         dv.textContent = $('#input-m_name')[0].value
         dv.className = 'fc-event'
         $(dv).data('event', {
           title: $.trim($(dv).text()),
           stick: true,
           id: 'loc_' + current_index
         });
         let obj = {
           'bindedDeviceId': $('#select-device :selected')[0].id,
           'formTemplateId': $('#select-form :selected')[0].id,
           'notificationOffset': $('#select-offset :selected')[0].value,
           'scheduleId': 'loc_' + current_index
         }
         sdlmanager.AddTempSdl(obj) //將之後要發配的表單儲存，因為Server api設計 不能做到一次新增 所以才要做暫存
         current_index++
         $(dv).draggable({
           zIndex: 999,
           revert: true,
           revertDuration: 0
         });
         $('#external-events').append(dv)
         $('#myModal')[0].style.display = "none";
         $('#calendar')[0].style.display = "block";
       })
       window.onclick = function (event) {
        if (event.target == $('#myModal')[0]) {
          $('#myModal')[0].style.display = "none";
          $('#calendar')[0].style.display = "block";
        }
      }
      $('#save-btn').on('click', () => {
         sdlmanager.SaveSdl()
      })
      $('#staff-list').change(function () {
        sdlmanager.ShowSdl()
      });
      $('#select-device').change(function () {
        sdlmanager.ShowForm()
        console.log('click')
      });

    });
  </script>
</head>
<body>
<div id='wrap'>
<div id="myModal" class="modal">
  <!-- Modal content -->
  <div class="modal-content">
    <span class="close">&times;</span>
    <p>任務名稱</p>
    <input type="text" id="input-m_name">
    <p>選擇設備</p>
    <select id="select-device">
      <option disabled selected value> -- select an option -- </option>
    </select>
    <p>選擇表單</p>
      <select id="select-form">
        <option disabled selected value> -- select an option -- </option>
      </select>
    <p>隔幾天通知</p>
      <select id="select-offset">
        <option disabled selected value> -- select an option -- </option>
        <option>0</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
      </select>
      <br>
      <button id="confirm">確認</button>
  </div>

</div>
  <div id="sidebar">
    <div class="sidebar-header">
      <h3 id="close_btn">Close &times;</h3>
      <h3 id="user-name"></h3>
      <button id="logout_btn">登出</button>
    </div>
    <ul id="sidebar-option">
    </ul>
  </div>
  <div id='external-events'>
    <button type="button" id="sidebarCollapse" class="btn btn-info navbar-btn">
      <i class="glyphicon glyphicon-align-left"></i>
      ☰
    </button>
    <select id="staff-list">
    </select>
    <button id="save-btn">Save</button>
    <h4>新增任務</h4>
    <p>
      <input type='checkbox' id='drop-remove' />
      <label for='drop-remove'>拖曳後移除</label>
    </p>
    <button id="add-event-btn" style="margin-left:70%;">+</button>
    <i class="fa fa-trash" style="font-size: 72px;" ></i>
  </div>

  <div id='calendar'></div>

  <div style='clear:both'></div>

</div>
</body>
</html>
